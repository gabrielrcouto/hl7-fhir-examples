<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

    <title>Registrar Produto - VISA üî•</title>
  </head>
  <body>

    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <a class="navbar-brand" href="#">VISA üî•</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item active">
            <a class="nav-link" href="autorizar-produto.html">Autorizar Produto</a>
          </li>
          <li class="nav-item active">
            <a class="nav-link" href="registrar-produto.html">Registrar Produto</a>
          </li>
          <li class="nav-item active">
            <a class="nav-link" href="registrar-interacao.html">Registrar Intera√ß√£o</a>
          </li>
          <li class="nav-item active">
            <a class="nav-link" href="prescrever.html">Prescrever</a>
          </li>
        </ul>
      </div>
    </nav>

    <div class="container">
      <h2>Registrar Produto</h2>

      <form autocomplete="off">
        <div class="form-group">
          <label>Nome do Produto</label>
          <input type="text" class="form-control" id="productName" autocomplete="off">
        </div>

        <div class="form-row">
          <div class="form-group col-md-10">
            <label>Quantidade do princ√≠pio ativo</label>
            <input type="text" class="form-control" id="strength" autocomplete="off">
          </div>
          <div class="form-group col-md-2">
            <label>Unidade de medida</label>
            <select id="strengthUnit" class="form-control">
              <option selected>g</option>
              <option>mg</option>
              <option>g/L</option>
              <option>g/mL</option>
              <option>L</option>
              <option>mL</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>Forma F√≠sica</label>
          <select id="doseForm" class="form-control">
              <option selected>C√°psula</option>
              <option>Comprimido</option>
              <option>Adesivo</option>
              <option>Pastilha</option>
            </select>
        </div>

        <div class="form-row align-items-center">
          <div class="form-group col-md-7">
            <label>Princ√≠pio Ativo</label>
            <select id="ingredient" class="form-control">
                <option selected>Fluoxetina</option>
                <option>Amoxicilina</option>
                <option>Cetamina</option>
                <option>Vitamina C</option>
              </select>
          </div>

          <div class="form-group col-md-2">
            <label>Concentra√ß√£o/Dilui√ß√£o</label>
            <input type="text" class="form-control" id="ingredientStrength" autocomplete="off">
          </div>

          <div class="form-group col-md-2">
            <label>Unidade de medida</label>
            <select id="ingredientStrengthUnit" class="form-control">
              <option selected>g</option>
              <option>mg</option>
              <option>g/L</option>
              <option>g/mL</option>
              <option>L</option>
              <option>mL</option>
            </select>
          </div>

          <div class="col-md-1">
            <button type="button" class="btn btn-secondary" style="margin-top: 14px">+</button>
          </div>
        </div>
        
        <button type="submit" class="btn btn-primary" id="registrar">Registrar</button>
      </form>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>

    <script type="text/javascript">
      /**
       * Gera um objeto que representa o recurso MedicinalProduct,
       * o qual representa um produto medicinal.
       */
      function getMedicinalProductObject() {
        return {
          "resourceType": "MedicinalProduct",
          "name": [
            {
              "productName": [$('#productName').val(), $('#strength').val(), $('#strengthUnit').val()].join(' '),
              "namePart": [
                {
                  "part": $('#productName').val(),
                  "type": {
                    "code": "INV"
                  }
                },
                {
                  "part": [$('#strength').val(), $('#strengthUnit').val()].join(' '),
                  "type": {
                    "code": "STR"
                  }
                },
                {
                  "part": $('#doseForm').val(),
                  "type": {
                    "code": "FRM"
                  }
                }
              ],
              "countryLanguage": [
                {
                  "country": {
                    "coding": [
                      {
                        "system": "http://www.saude.gov.br/fhir/countryCode",
                        "code": "BR"
                      }
                    ]
                  },
                  "jurisdiction": {
                    "coding": [
                      {
                        "system": "http://www.saude.gov.br/fhir/jurisdictionCode",
                        "code": "BR"
                      }
                    ]
                  },
                  "language": {
                    "coding": [
                      {
                        "system": "http://www.saude.gov.br/fhir/languageCode",
                        "code": "BR"
                      }
                    ]
                  }
                }
              ]
            }
          ],
          "pharmaceuticalProduct": {
            "reference": "urn:uuid:74891afc-ed52-42a2-bcd7-f13d9b60f096"
          }
        };
      };

      /**
       * Gera um objeto que representa o recurso MedicinalProductPharmaceutical,
       * o qual representa um produto medicinal farmac√™utico.
       */
      function getMedicinalProductPharmaceuticalObject() {
        return {
          "resourceType": "MedicinalProductPharmaceutical",
          "administrableDoseForm": {
            "system": "http://www.saude.gov.br/fhir/administrableDoseForm",
            "code": $('#doseForm').val()
          },
          "ingredient": [
            {
              "reference": "urn:uuid:88f151c0-a954-468a-88bd-5ae15c08e059"
            }
          ]
        };
      };

      /**
       * Gera um objeto que representa o recurso MedicinalProductIngredient,
       * o qual representa um ingrediente de um produto medicinal farmac√™utico.
       */
      function getMedicinalProductIngredientObject() {
        return {
          "resourceType": "MedicinalProductIngredient",
          "role": {
            "system": "http://www.saude.gov.br/fhir/ingredientRole",
            "code": "active ingredient"
          },
          "substance": {
            "code": {
              "system": "http://www.saude.gov.br/fhir/substance",
              "code": $('#ingredient').val()
            },
            "strength": [
              {
                "presentation": {
                  "numerator": {
                    "value": $('#ingredientStrength').val(),
                    "unit": $('#ingredientStrengthUnit').val()
                  },
                  "denominator": {
                    "value": 1,
                    "unit": $('#doseForm').val()
                  }
                }
              }
            ]
          }
        };
      };

      /**
       * Gera o objeto Bundle, o qual cadastrar√° tr√™s recursos:
       * - MedicinalProduct
       * - MedicinalProductIngredient
       * - MedicinalProductPharmaceutical
       */
      function getBundleObject() {
        return {
          "resourceType": "Bundle",
          "id": "bundle-transaction",
          "type": "transaction",
          "entry": [
            {
              "resource": getMedicinalProductObject(),
              "request": {
                "method": "POST",
                "url": "MedicinalProduct"
              }
            },
            {
              "fullUrl": "urn:uuid:88f151c0-a954-468a-88bd-5ae15c08e059",
              "resource": getMedicinalProductIngredientObject(),
              "request": {
                "method": "POST",
                "url": "MedicinalProductIngredient"
              }
            },
            {
              "fullUrl": "urn:uuid:74891afc-ed52-42a2-bcd7-f13d9b60f096",
              "resource": getMedicinalProductPharmaceuticalObject(),
              "request": {
                "method": "POST",
                "url": "MedicinalProductPharmaceutical"
              }
            },
          ]
        };
      };

      $(document).ready(() => {
        $('form').submit(() => {
          const settings = {
            async: true,
            contentType: 'application/fhir+json',
            crossDomain: true,
            url: 'http://localhost:8090/fhir/',
            method: 'POST',
            data: JSON.stringify(getBundleObject()),
            dataType: 'json',
            processData: false
          };

          $('#registrar').html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>');

          $.ajax(settings).done((response) => {
            $('#registrar').html('‚úÖ');
          });

          return false;
        });
      });
    </script>
  </body>
</html>